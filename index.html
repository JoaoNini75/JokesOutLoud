<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jokes Out Loud</title>
</head>
<body>
    <h1>Jokes Out Loud</h1>
    <button id="tellJoke">Tell me a joke</button>
    <br><br>
    <p id="setup"></p>
    <p id="delivery"></p>
    <br><br>
    <p id="category"></p>

<style>

    body {
        background-color: #333333;
        color: #eeeeee;
    }

</style>

<script>
    const tellJokeBtn = document.getElementById("tellJoke");
    const setupElem = document.getElementById("setup");
    const deliveryElem = document.getElementById("delivery");
    const categoryElem = document.getElementById("category");

    const synth = window.speechSynthesis;
    let utterThis;

    document.onload = main();

    function main() {
        let categories = [], blacklist = [], jokeTypes = [true, true];

        tellJokeBtn.addEventListener("click", function() {
            requestJoke(buildURL(categories, blacklist, jokeTypes));
        });
    }

    function buildURL(categories, blacklist, jokeTypes) {
        let url = "https://v2.jokeapi.dev/joke/";
        let blacklistEmpty = true;

        if (categories.length == 0)
            url += "Any";
        else {
            for (let i = 0; i < categories.length; i++) {
                url += categories[i];
                if (i != categories.length - 1)
                    url += ",";
            } 
        }

        if (blacklist.length > 0) {
            blacklistEmpty = false;
            url += "?blacklistFlags=";

            for (let i = 0; i < blacklist.length; i++) {
                url += blacklist[i];
                if (i != blacklist.length - 1)
                    url += ",";
            }
        }

        if (!jokeTypes[0] && !jokeTypes[1]) 
            alert("You have to select at least one joke type.");
        else if ((jokeTypes[0] && !jokeTypes[1]) || !jokeTypes[0] && jokeTypes[1])
            url += (blacklistEmpty ? "?" : "&") + "type=" + (jokeTypes[0] ? "single" : "twopart");

        console.log(url);
        return url;
    }

    function requestJoke(url) {
        let xhttp = new XMLHttpRequest();

        xhttp.onreadystatechange = function() {
            if (this.readyState == 4) {
                if (this.status != 200) {
                    alert("An error has occurred :(");
                } else {
                    const json = JSON.parse(xhttp.responseText);
                    console.log(json);
                    synth.cancel();

                    if (json.type == "single") {
                        setupElem.innerText = json.joke;

                        // speak
                        utterThis = new SpeechSynthesisUtterance(json.joke);
                        utterThis.voice = synth.getVoices()[4];
                        utterThis.rate = 1.15;
                        synth.speak(utterThis);
                    } else {
                        setupElem.innerText = json.setup;
                        deliveryElem.innerText = json.delivery;

                        // speak
                        utterThis = new SpeechSynthesisUtterance(json.setup);
                        utterThis.voice = synth.getVoices()[4];
                        utterThis.rate = 1.15;
                        synth.speak(utterThis);

                        sleep(300);

                        utterThis = new SpeechSynthesisUtterance(json.delivery);
                        utterThis.voice = synth.getVoices()[4];
                        utterThis.rate = 1.12;
                        synth.speak(utterThis);
                    }

                    categoryElem.innerText = "Category: " + json.category;
                }
            }
        };

        xhttp.open("GET", url, true);
        xhttp.send();
    }

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

</script>
</body>
</html>